---
import type { SEOProps } from '@/types';
import { SITE_CONFIG } from '@/config/site';
import '@/styles/global.css';

export interface Props extends SEOProps {
  class?: string;
}

const {
  title,
  description,
  image,
  url = Astro.url.href,
  type = 'website',
  publishDate,
  author = SITE_CONFIG.author,
  class: className = '',
} = Astro.props;

// Generate full title with site name
const fullTitle = title === SITE_CONFIG.title ? title : `${title} | ${SITE_CONFIG.title}`;

// Generate canonical URL
const canonicalUrl = new URL(url, SITE_CONFIG.url).href;

// Generate Open Graph image URL
const ogImage = image ? new URL(image, SITE_CONFIG.url).href : `${SITE_CONFIG.url}/og-default.png`;

// Security: Sanitize meta content
const sanitizeContent = (content: string) => content.replace(/[<>]/g, '');
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    
    <!-- SEO Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="description" content={sanitizeContent(description)} />
    <meta name="author" content={sanitizeContent(author)} />
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content={type} />
    <meta property="og:title" content={sanitizeContent(fullTitle)} />
    <meta property="og:description" content={sanitizeContent(description)} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={SITE_CONFIG.title} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={sanitizeContent(title)} />
    <meta property="og:locale" content="en_US" />
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={sanitizeContent(fullTitle)} />
    <meta name="twitter:description" content={sanitizeContent(description)} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={sanitizeContent(title)} />
    {SITE_CONFIG.social.twitter && (
      <meta name="twitter:site" content={`@${SITE_CONFIG.social.twitter.split('/').pop()}`} />
    )}
    
    <!-- Article-specific meta tags -->
    {type === 'article' && publishDate && (
      <>
        <meta property="article:published_time" content={publishDate.toISOString()} />
        <meta property="article:author" content={sanitizeContent(author)} />
      </>
    )}
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    
    <!-- Font Preloading for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    
    <!-- Preload critical resources for performance -->
    <link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/jetbrains-mono-var.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Preload critical CSS -->
    <link rel="preload" href="/styles/global.css" as="style" />
    
    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    
    <!-- Preconnect to image CDN if using external images -->
    <link rel="preconnect" href="https://images.unsplash.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    
    <!-- Preload above-the-fold images based on page type -->
    {Astro.url.pathname === '/' && (
      <>
        <link rel="preload" as="image" href="/images/astro-hero.jpg" type="image/jpeg" fetchpriority="high" />
        <link rel="preload" as="image" href="/images/python-async-hero.jpg" type="image/jpeg" />
        <link rel="preload" as="image" href="/images/typescript-hero.jpg" type="image/jpeg" />
      </>
    )}
    
    <!-- Preload featured image for blog posts -->
    {image && type === 'article' && (
      <link rel="preload" as="image" href={image} type="image/webp" fetchpriority="high" />
    )}
    
    <!-- Preload critical JavaScript modules -->
    <link rel="modulepreload" href="/src/utils/performance.js" />
    
    <!-- Resource hints for better performance -->
    <link rel="prefetch" href="/blog" />
    <link rel="prefetch" href="/rss.xml" />
    
    <!-- Preload critical above-the-fold content -->
    {Astro.url.pathname === '/' && (
      <link rel="prefetch" href="/blog" as="document" />
    )}
    
    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title={SITE_CONFIG.title} href="/rss.xml" />
    
    <!-- Sitemap -->
    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a" />
    <meta name="color-scheme" content="light dark" />
    
    <!-- Structured Data for SEO -->
    {type === 'website' && (
      <script type="application/ld+json" is:inline set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": SITE_CONFIG.title,
        "description": SITE_CONFIG.description,
        "url": SITE_CONFIG.url,
        "author": {
          "@type": "Person",
          "name": SITE_CONFIG.author
        }
      })} />
    )}
    
    {type === 'article' && publishDate && (
      <script type="application/ld+json" is:inline set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": title,
        "description": description,
        "image": ogImage,
        "author": {
          "@type": "Person",
          "name": author
        },
        "publisher": {
          "@type": "Organization",
          "name": SITE_CONFIG.title,
          "logo": {
            "@type": "ImageObject",
            "url": `${SITE_CONFIG.url}/logo.png`
          }
        },
        "datePublished": publishDate.toISOString(),
        "dateModified": publishDate.toISOString(),
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": canonicalUrl
        }
      })} />
    )}
  </head>
  
  <body class={`min-h-screen bg-white text-primary-900 font-sans antialiased ${className}`}>
    <!-- Skip to main content for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-accent-600 text-white px-4 py-2 rounded-md z-50 transition-all duration-200"
    >
      Skip to main content
    </a>
    
    <!-- Main content wrapper -->
    <div class="flex flex-col min-h-screen">
      <slot />
    </div>
    
    <!-- Performance and Analytics Scripts -->
    <script>
      // Security: Prevent clickjacking
      if (window.top && window.top !== window.self) {
        window.top.location.href = window.self.location.href;
      }
      
      // Performance: Preload critical resources on interaction
      const preloadOnInteraction = () => {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = '/blog';
        document.head.appendChild(link);
      };
      
      // Add event listeners for preloading
      ['mouseenter', 'touchstart', 'focus'].forEach(event => {
        document.addEventListener(event, preloadOnInteraction, { once: true, passive: true });
      });
    </script>
    
    <!-- Performance monitoring script -->
    <script>
      // Initialize performance optimizations when DOM is ready
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          // Dynamically import performance utilities
          const { initPerformanceOptimizations, logPerformanceMetrics, preloadCriticalResources } = await import('../utils/performance.js');
          
          // Initialize performance monitoring
          initPerformanceOptimizations();
          
          // Preload critical resources
          preloadCriticalResources();
          
          // Log performance metrics in development
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => logPerformanceMetrics(), 2000);
          }
        } catch (error) {
          console.warn('Performance monitoring failed to initialize:', error);
        }
      });
      
      // Critical performance optimizations that should run immediately
      (function() {
        // Preload resources on user interaction
        const preloadOnInteraction = () => {
          const link = document.createElement('link');
          link.rel = 'prefetch';
          link.href = '/blog';
          document.head.appendChild(link);
        };
        
        // Add event listeners for preloading
        ['mouseenter', 'touchstart', 'focus'].forEach(event => {
          document.addEventListener(event, preloadOnInteraction, { once: true, passive: true });
        });
        
        // Optimize font loading
        if ('fonts' in document) {
          document.fonts.ready.then(() => {
            document.documentElement.classList.add('fonts-loaded');
          });
        }
        
        // Add performance observer for navigation timing
        if ('PerformanceObserver' in window) {
          try {
            const navObserver = new PerformanceObserver((list) => {
              const entries = list.getEntries();
              entries.forEach((entry) => {
                if (entry.entryType === 'navigation') {
                  const navEntry = entry as PerformanceNavigationTiming;
                  console.log('Navigation timing:', {
                    'DNS': navEntry.domainLookupEnd - navEntry.domainLookupStart,
                    'TCP': navEntry.connectEnd - navEntry.connectStart,
                    'Request': navEntry.responseStart - navEntry.requestStart,
                    'Response': navEntry.responseEnd - navEntry.responseStart,
                    'DOM Processing': navEntry.domComplete - navEntry.responseEnd,
                    'Load Complete': navEntry.loadEventEnd - navEntry.fetchStart
                  });
                }
              });
            });
            navObserver.observe({ type: 'navigation', buffered: true });
          } catch (e) {
            console.warn('Navigation observer not supported');
          }
        }
      })();
    </script>
  </body>
</html>